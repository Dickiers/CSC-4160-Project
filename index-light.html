<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stock Market Analysis Dashboard</title>
    <!-- Load Tailwind CSS for modern, responsive styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Chart.js for data visualization -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <!-- Load Chart.js Financial Library for Candlestick Charts -->
    <script src="https://cdn.jsdelivr.net/npm/chartjs-chart-financial@0.1.0/dist/chartjs-chart-financial.min.js"></script>
    <!-- Load lucide-react icons (we use the non-react version here) -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <style>
        /* Custom scrollbar styling for a cleaner look */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f9fafb; } /* gray-50 */
        ::-webkit-scrollbar-thumb { background: #d1d5db; border-radius: 4px; } /* gray-300 */
        ::-webkit-scrollbar-thumb:hover { background: #9ca3af; } /* gray-400 */

        html, body { height: 100%; margin: 0; font-family: 'Inter', sans-serif; }
        
        body {
            background-color: #f9fafb; /* gray-50 */
            color: #1f2937; /* gray-800 */
        }
        #historicalTableBody tr:nth-child(even) {
            background-color: #f3f4f6; /* gray-100 for zebra stripping */
        }
        /* Performance table zebra stripping */
        #performanceTableBody tr:nth-child(even) {
            background-color: #f3f4f6; /* gray-100 */
        }

        /* REMOVED .nav-tab styles */
        /* REMOVED .page-content.hidden styles */
    </style>
</head>
<body class="min-h-screen p-4 sm:p-8">

    <!-- Main Dashboard Container -->
    <div id="app" class="max-w-7xl mx-auto">
        
        <!-- Header / Navigation -->
        <header class="bg-emerald-700 p-4 rounded-xl shadow-xl mb-8 flex flex-col lg:flex-row items-center justify-between space-y-4 lg:space-y-0">
            <h1 class="text-2xl font-bold text-white flex-shrink-0">Stock Market ETL Analysis</h1>
            
            <!-- REMOVED: <nav> element with tabs -->

            <div class="flex space-x-2">
                <input type="text" id="symbolInput" placeholder="Enter Ticker Symbol (e.g., MSFT)"
                       class="w-72 p-3 rounded-lg border-2 border-gray-300 bg-gray-100 text-gray-900 placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-emerald-300 transition duration-150 hover:shadow-md">
                
                <button id="searchButton"
                        class="bg-emerald-600 hover:bg-emerald-500 text-white font-semibold py-3 px-4 rounded-lg shadow-md transition duration-150 transform hover:scale-105 flex items-center space-x-2 flex-shrink-0">
                    <span data-lucide="search" class="w-5 h-5"></span>
                    <span class="inline">Analyze</span>
                </button>
            </div>
        </header>

        <!-- Page 1: Stock Dashboard (No longer needs page wrapper) -->
        <div id="pageStockDashboard" class="space-y-8">
            
            <main class="grid grid-cols-1 lg:grid-cols-4 gap-8">
                
                <!-- Left Column: Company Profile and Key Metrics (lg:col-span-1) -->
                <section class="lg:col-span-1 space-y-8">
                    
                    <!-- Company Profile Card -->
                    <div id="companyProfileCard" class="bg-white p-6 rounded-xl shadow-xl border-t-4 border-emerald-500">
                        <h2 class="text-xl font-semibold mb-4 text-emerald-600">Company Profile</h2>
                        <div id="companyName" class="text-2xl font-bold mb-1 text-gray-800">Stock Name</div>
                        <div id="companySymbol" class="text-lg text-gray-500 mb-4">TICKER</div>
                        
                        <!-- UPDATED: Added new data fields from transform.py -->
                        <div id="companyDetails" class="space-y-3 text-gray-700">
                            <p><span class="font-medium text-emerald-600">Industry:</span> <span id="industryValue">Loading...</span></p>
                            <p><span class="font-medium text-emerald-600">Market Cap:</span> <span id="marketCapValue">Loading...</span></p>
                            <p><span class="font-medium text-emerald-600">P/E Ratio:</span> <span id="peRatioValue">Loading...</span></p>
                            <p><span class="font-medium text-emerald-600">52-Week High:</span> <span id="week52HighValue">Loading...</span></p>
                            <p><span class="font-medium text-emerald-600">52-Week Low:</span> <span id="week52LowValue">Loading...</span></p>
                        </div>

                        <div id="companyDescription" class="mt-4 text-sm max-h-40 overflow-y-auto pr-2">
                            <p class="text-gray-500 italic">Description will appear here after fetching data.</p>
                        </div>
                    </div>

                    <!-- NEW CARD: Key Performance -->
                    <div id="keyPerformanceCard" class="bg-white p-6 rounded-xl shadow-xl">
                        <h2 class="text-xl font-semibold mb-4 text-emerald-600">Key Performance</h2>
                        <div class="overflow-x-auto">
                            <table class="min-w-full">
                                <tbody id="performanceTableBody" class="divide-y divide-gray-200 text-gray-700">
                                    <!-- Rows will be inserted by JS -->
                                    <tr>
                                        <td class="px-4 py-3 font-medium">1-Day Change</td>
                                        <td id="perf1day" class="px-4 py-3 text-right font-semibold">--</td>
                                    </tr>
                                    <tr>
                                        <td class="px-4 py-3 font-medium">5-Day Change</td>
                                        <td id="perf5day" class="px-4 py-3 text-right font-semibold">--</td>
                                    </tr>
                                    <tr>
                                        <td class="px-4 py-3 font-medium">1-Month Change</td>
                                        <td id="perf1month" class="px-4 py-3 text-right font-semibold">--</td>
                                    </tr>
                                    <tr>
                                        <td class="px-4 py-3 font-medium">1-Year Change</td>
                                        <td id="perf1year" class="px-4 py-3 text-right font-semibold">--</td>
                                    </tr>
                                    <tr>
                                        <td class="px-4 py-3 font-medium">5-Year Change</td>
                                        <td id="perf5year" class="px-4 py-3 text-right font-semibold">--</td>
                                    </tr>
                                    <tr>
                                        <td class="px-4 py-3 font-medium">YTD Change</td>
                                        <td id="perfYTD" class="px-4 py-3 text-right font-semibold">--</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                </section>

                <!-- Right Column: Charts and Data (lg:col-span-3) -->
                <section class="lg:col-span-3 space-y-8">

                    <!-- Chart Area 1: Candlestick and Volume -->
                    <div id="priceVolumeChartContainer" class="bg-white p-6 rounded-xl shadow-xl">
                        <h2 class="text-xl font-semibold mb-4 text-emerald-600">Price & Volume Trend</h2>
                        <div id="priceChartCanvasWrapper" class="relative w-full h-96">
                            <canvas id="priceChart"></canvas>
                            <div id="loadingOverlay" class="absolute inset-0 bg-white/90 flex items-center justify-center rounded-xl transition-opacity duration-300 opacity-0 pointer-events-none">
                                <div class="text-center">
                                    <span class="animate-spin h-8 w-8 border-4 border-emerald-500 border-t-transparent rounded-full block mx-auto mb-2"></span>
                                    <p class="text-gray-800">Fetching and analyzing data...</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- RSI Indicator Chart -->
                    <div id="rsiChartContainer" class="bg-white p-6 rounded-xl shadow-xl">
                        <h2 class="text-xl font-semibold mb-4 text-emerald-600">Relative Strength Index (RSI)</h2>
                        <div id="rsiChartCanvasWrapper" class="relative w-full h-48">
                            <canvas id="rsiChart"></canvas>
                        </div>
                    </div>

                    <!-- Key Metrics/Technical Indicators Table -->
                    <div class="bg-white p-6 rounded-xl shadow-xl">
                        <h2 class="text-xl font-semibold mb-4 text-emerald-600">Key Technical Metrics</h2>
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-100">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">Metric</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">Value</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">Notes</th>
                                    </tr>
                                </thead>
                                <tbody id="metricsTableBody" class="divide-y divide-gray-200 text-gray-700">
                                    <tr>
                                        <td class="px-6 py-4 whitespace-nowrap font-medium">50-Day Moving Average (MA)</td>
                                        <td id="ma50Value" class="px-6 py-4 whitespace-nowrap text-emerald-600">--</td>
                                        <td class="px-6 py-4 text-sm text-gray-500">Short-term trend line.</td>
                                    </tr>
                                    <tr>
                                        <td class="px-6 py-4 whitespace-nowrap font-medium">200-Day Moving Average (MA)</td>
                                        <td id="ma200Value" class="px-6 py-4 whitespace-nowrap text-emerald-600">--</td>
                                        <td class="px-6 py-4 text-sm text-gray-500">Long-term trend line.</td>
                                    </tr>
                                    <tr>
                                        <td class="px-6 py-4 whitespace-nowrap font-medium">Relative Strength Index (RSI)</td>
                                        <td id="rsiValue" class="px-6 py-4 whitespace-nowrap text-emerald-600">--</td>
                                        <td class="px-6 py-4 text-sm text-gray-500">Momentum indicator (0-100).</td>
                                    </tr>
                                    <tr>
                                        <td class="px-6 py-4 whitespace-nowrap font-medium">Latest Adjusted Close</td>
                                        <td id="latestCloseValue" class="px-6 py-4 whitespace-nowrap text-emerald-600">--</td>
                                        <td class="px-6 py-4 text-sm text-gray-500">Price adjusted for splits/dividends.</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Historical Daily Data Table -->
                    <div class="bg-white p-6 rounded-xl shadow-xl">
                        <h2 class="text-xl font-semibold mb-4 text-emerald-600">Historical Daily Data</h2>
                        <div class="overflow-x-auto max-h-96">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-100 sticky top-0">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">Date</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">Open</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">High</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">Low</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">Close</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">Volume</th>
                                    </tr>
                                </thead>
                                <tbody id="historicalTableBody" class="divide-y divide-gray-200 text-gray-700">
                                    <tr><td colspan="6" class="p-4 text-center text-gray-500">Loading historical data...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </section>
            </main>
        </div> <!-- End of Page 1: Stock Dashboard -->


        <!-- REMOVED: Page 2: Portfolio Dashboard -->

    </div>

    <script>
        lucide.createIcons();
        
        const CHART_GRID_COLOR = 'rgba(209, 213, 219, 0.5)'; // gray-300
        const CHART_TICK_COLOR = '#4b5563'; // gray-600

        // --- GLOBAL SETUP & FIREBASE INIT ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let db, auth, userId;
        let priceChartInstance = null;
        let rsiChartInstance = null;

        async function initializeFirebase() {
            try {
                const { initializeApp } = await import("https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js");
                const { getAuth, signInAnonymously, signInWithCustomToken } = await import("https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js");
                const { getFirestore, doc, getDoc } = await import("https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js");

                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }
                
                userId = auth.currentUser?.uid || crypto.randomUUID();
                console.log("Firebase initialized. User ID:", userId);
                setupEventListeners();

            } catch (error) {
                console.error("Error initializing Firebase:", error);
                displayError("Cannot connect to database. Check console.");
            }
        }

        // --- REMOVED: PAGE NAVIGATION LOGIC ---

        // --- DATA FETCHING FUNCTIONS ---
        function showLoading(isVisible) {
            const overlay = document.getElementById('loadingOverlay');
            if (isVisible) {
                overlay.classList.remove('opacity-0', 'pointer-events-none');
            } else {
                overlay.classList.add('opacity-0', 'pointer-events-none');
            }
        }

        /**
         * @typedef {Object} TransformedData
         * @property {Object} clean_profile - Basic company info
         * @property {Array<Object>} transformed_daily_data - OHLCV data + metrics
         * @property {Object} transformed_performance_index - % change metrics
         */

        /**
         * Fetches data from Firestore or displays mock data if running locally.
         * @param {string} symbol - The stock ticker symbol.
         */
        async function fetchStockData(symbol) {
            let dataToDisplay = null;
            const formattedSymbol = symbol.toUpperCase();
            const isLocalDev = window.location.protocol === 'file:' || window.location.hostname === '127.0.0.1';

            try {
                showLoading(true);

                if (isLocalDev) {
                    // --- LOCAL DEVELOPMENT MOCK DATA PATH ---
                    dataToDisplay = generateMockData(formattedSymbol);
                    console.warn("Running in local development mode. Displaying MOCK data.");

                } else {
                    // --- DEPLOYED FIREBASE FETCH PATH ---
                    if (!db) {
                        console.error("Firestore not initialized.");
                        displayError("Database connection failed. Check authentication.");
                        return;
                    }
                    
                    const dataPath = `artifacts/${appId}/public/data/stock_data`;
                    const docRef = doc(db, dataPath, formattedSymbol);
                    const docSnap = await getDoc(docRef);

                    if (docSnap.exists()) {
                        dataToDisplay = docSnap.data(); 
                        
                        dataToDisplay.transformed_daily_data.forEach(d => {
                            if (d.x && typeof d.x.toDate === 'function') {
                                d.x = d.x.toDate().getTime();
                            }
                        });
                        
                        console.log("Real Data fetched and converted:", dataToDisplay);
                    } else {
                        displayError(`No processed data found for symbol: ${formattedSymbol}`);
                        return;
                    }
                }

                if (dataToDisplay) {
                    displayData(dataToDisplay);
                }

            } catch (error) {
                console.error("Error during data fetching process:", error);
                displayError("A critical error occurred while fetching data.");
            } finally {
                showLoading(false);
            }
        }


        // --- MOCK DATA GENERATION ---
        function generateMockData(symbol) {
            const dailyData = [];
            let currentPrice = 150;
            const today = new Date();
            const closePrices = []; 
            const dates = [];

            for (let i = 252; i >= 0; i--) {
                const date = new Date(today);
                date.setDate(today.getDate() - i);
                const dateTimestamp = date.getTime();
                
                const change = (Math.random() - 0.5) * 5;
                const open = currentPrice;
                const close = currentPrice + change;
                const high = Math.max(open, close) + Math.random() * 2;
                const low = Math.min(open, close) - Math.random() * 2;
                const volume = Math.floor(Math.random() * 50000000);
                
                closePrices.push(close);
                dates.push(dateTimestamp);

                dailyData.push({ 
                    x: dateTimestamp, 
                    o: open, h: high, l: low, c: close, v: volume,
                    sma_50: null, sma_200: null, rsi_14: null
                });
                currentPrice = close;
            }
            
            for (let i = 0; i < dailyData.length; i++) {
                if (i >= 49) {
                    const sum = closePrices.slice(i - 49, i + 1).reduce((a, b) => a + b, 0);
                    dailyData[i].sma_50 = sum / 50;
                }
                if (i >= 199) {
                    const sum = closePrices.slice(i - 199, i + 1).reduce((a, b) => a + b, 0);
                    dailyData[i].sma_200 = sum / 200;
                }
                if (i >= 13) {
                    dailyData[i].rsi_14 = 40 + (Math.sin(i / 10) * 30) + (Math.random() * 10);
                }
            }
            
            const latestData = dailyData[dailyData.length - 1];
            const latestPrice = latestData.c;
            
            const clean_profile = {
                "Symbol": symbol,
                "Name": `MOCK Company (${symbol})`,
                "Industry": "Technology/Data Science (MOCK)",
                "MarketCapitalization": 1500000000000 + Math.floor(Math.random() * 50000000000),
                "Description": "This mock data perfectly matches the 'transform.py' output structure.",
                "PERatio": (Math.random() * 20 + 15).toFixed(2),
                "52WeekHigh": (Math.max(...closePrices.slice(-252)) * 1.05).toFixed(2),
                "52WeekLow": (Math.min(...closePrices.slice(-252)) * 0.95).toFixed(2)
            };
            
            const transformed_performance_index = {
                "1day_change_percent": (latestPrice - dailyData[dailyData.length - 2].c) / dailyData[dailyData.length - 2].c * 100,
                "5day_change_percent": (latestPrice - dailyData[dailyData.length - 6].c) / dailyData[dailyData.length - 6].c * 100,
                "month_change_percent": (latestPrice - dailyData[dailyData.length - 22].c) / dailyData[dailyData.length - 22].c * 100,
                "year_change_percent": (latestPrice - dailyData[dailyData.length - 252].c) / dailyData[dailyData.length - 252].c * 100,
                "5year_change_percent": (Math.random() * 200 - 50),
                "ytd_change_percent": (latestPrice - dailyData.find(d => new Date(d.x).getFullYear() === today.getFullYear()).c) / dailyData.find(d => new Date(d.x).getFullYear() === today.getFullYear()).c * 100
            };
            
            const transformed_daily_data = dailyData.filter(d => d.sma_200 !== null);

            return { clean_profile, transformed_daily_data, transformed_performance_index };
        }


        // --- UI RENDERING FUNCTIONS ---
        
        function displayData(data) {
            const overview = data.clean_profile;
            const dailyData = data.transformed_daily_data;
            const performance = data.transformed_performance_index;
            const latestData = dailyData[dailyData.length - 1]; 

            document.getElementById('companyName').textContent = overview.Name;
            document.getElementById('companySymbol').textContent = overview.Symbol;
            document.getElementById('industryValue').textContent = overview.Industry;
            document.getElementById('marketCapValue').textContent = formatCurrency(overview.MarketCapitalization);
            document.getElementById('companyDescription').textContent = overview.Description;
            document.getElementById('peRatioValue').textContent = parseFloat(overview.PERatio).toFixed(2);
            document.getElementById('week52HighValue').textContent = formatPrice(overview["52WeekHigh"], false);
            document.getElementById('week52LowValue').textContent = formatPrice(overview["52WeekLow"], false);

            document.getElementById('ma50Value').innerHTML = formatPrice(latestData.sma_50);
            document.getElementById('ma200Value').innerHTML = formatPrice(latestData.sma_200);
            document.getElementById('rsiValue').innerHTML = formatMetric(latestData.rsi_14, 70, 30);
            document.getElementById('latestCloseValue').innerHTML = formatPrice(latestData.c);

            drawPerformanceTable(performance);
            drawCharts(dailyData);
            drawRSIChart(dailyData);
            drawHistoricalTable(dailyData);
        }
        
        function drawPerformanceTable(performance) {
            document.getElementById('perf1day').innerHTML = formatPercentage(performance["1day_change_percent"]);
            document.getElementById('perf5day').innerHTML = formatPercentage(performance["5day_change_percent"]);
            document.getElementById('perf1month').innerHTML = formatPercentage(performance["month_change_percent"]);
            document.getElementById('perf1year').innerHTML = formatPercentage(performance["year_change_percent"]);
            document.getElementById('perf5year').innerHTML = formatPercentage(performance["5year_change_percent"]);
            document.getElementById('perfYTD').innerHTML = formatPercentage(performance["ytd_change_percent"]);
        }

        function drawHistoricalTable(dailyData) {
            const tableBody = document.getElementById('historicalTableBody');
            tableBody.innerHTML = ''; 

            dailyData.slice(-30).reverse().forEach(day => {
                const date = new Date(day.x).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
                const row = tableBody.insertRow();
                row.className = 'hover:bg-gray-200 transition duration-150';
                
                row.insertCell().className = 'px-6 py-4 whitespace-nowrap text-gray-700';
                row.insertCell().className = 'px-6 py-4 whitespace-nowGrap text-gray-700';
                row.insertCell().className = 'px-6 py-4 whitespace-nowrap text-gray-700';
                row.insertCell().className = 'px-6 py-4 whitespace-nowrap text-gray-700';
                row.insertCell().className = 'px-6 py-4 whitespace-nowrap text-gray-700';
                row.insertCell().className = 'px-6 py-4 whitespace-nowrap text-gray-700';

                row.cells[0].textContent = date;
                row.cells[1].textContent = day.o.toFixed(2);
                row.cells[2].textContent = day.h.toFixed(2);
                row.cells[3].textContent = day.l.toFixed(2);
                row.cells[4].textContent = day.c.toFixed(2);
                row.cells[5].textContent = day.v.toLocaleString('en-US');
            });
            
            if (dailyData.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="6" class="p-4 text-center text-gray-500">No historical data available.</td></tr>';
            }
        }

        // UPDATED: Removed pageId parameter
        function displayError(message) {
            document.getElementById('companyName').textContent = "DATA ERROR";
            document.getElementById('companySymbol').textContent = message;
            document.getElementById('industryValue').textContent = '--';
            document.getElementById('marketCapValue').textContent = '--';
            document.getElementById('companyDescription').textContent = 'Please try a different symbol or check the console for API issues.';
            document.getElementById('peRatioValue').textContent = '--';
            document.getElementById('week52HighValue').textContent = '--';
            document.getElementById('week52LowValue').textContent = '--';
            document.getElementById('ma50Value').textContent = '--';
            document.getElementById('ma200Value').textContent = '--';
            document.getElementById('rsiValue').textContent = '--';
            document.getElementById('latestCloseValue').textContent = '--';
            
            document.getElementById('perf1day').textContent = '--';
            document.getElementById('perf5day').textContent = '--';
            document.getElementById('perf1month').textContent = '--';
            document.getElementById('perf1year').textContent = '--';
            document.getElementById('perf5year').textContent = '--';
            document.getElementById('perfYTD').textContent = '--';
            
            document.getElementById('priceChartCanvasWrapper').innerHTML = '<canvas id="priceChart"></canvas>';
            document.getElementById('rsiChartCanvasWrapper').innerHTML = '<canvas id="rsiChart"></canvas>'; 
            document.getElementById('historicalTableBody').innerHTML = '<tr><td colspan="6" class="p-4 text-center text-gray-500">No data available.</td></tr>';
            
            if (priceChartInstance) { priceChartInstance.destroy(); priceChartInstance = null; }
            if (rsiChartInstance) { rsiChartInstance.destroy(); rsiChartInstance = null; }
        }

        // --- FORMATTING HELPERS ---
        function formatCurrency(value) {
            return new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD', notation: 'compact' }).format(value);
        }

        function formatPrice(value, addColor = true) {
            const price = parseFloat(value).toFixed(2);
            if (!addColor) return `$${price}`; 

            let colorClass = 'text-emerald-600'; 
            if (price > 155) { colorClass = 'text-green-600'; }
            if (price < 145) { colorClass = 'text-red-600'; }
            
            return `<span class="${colorClass}">$${price}</span>`;
        }

        function formatMetric(value, highThreshold, lowThreshold) {
            const formattedValue = parseFloat(value).toFixed(2);
            let colorClass = 'text-gray-700'; 
            if (value > highThreshold) { colorClass = 'text-red-600 font-bold'; } 
            else if (value < lowThreshold) { colorClass = 'text-green-600 font-bold'; }
            return `<span class="${colorClass}">${formattedValue}</span>`;
        }
        
        function formatPercentage(value) {
            const formattedValue = parseFloat(value).toFixed(2) + '%';
            let colorClass = 'text-gray-700';
            if (value > 0) { colorClass = 'text-green-600'; }
            else if (value < 0) { colorClass = 'text-red-600'; }
            return `<span class="${colorClass}">${formattedValue}</span>`;
        }


        // --- CHART.JS IMPLEMENTATION: PRICE AND VOLUME ---
        function drawCharts(dailyData) {
            if (priceChartInstance) { priceChartInstance.destroy(); }

            const ctx = document.getElementById('priceChart').getContext('2d');
            
            const priceData = dailyData.map(d => ({ x: d.x, o: d.o, h: d.h, l: d.l, c: d.c }));
            const volumeData = dailyData.map(d => ({ x: d.x, y: d.v }));
            const ma50Data = dailyData.map(d => ({ x: d.x, y: d.sma_50 }));
            const ma200Data = dailyData.map(d => ({ x: d.x, y: d.sma_200 }));

            const datasets = [
                {
                    label: 'Price', type: 'candlestick', data: priceData, yAxisID: 'yPrice',
                    itemStyle: { color: '#10b981', borderColor: '#dc2626' }
                },
                {
                    label: '50-Day MA', type: 'line', data: ma50Data, yAxisID: 'yPrice',
                    borderColor: '#fde047', // yellow-300
                    borderWidth: 2, pointRadius: 0, fill: false, tension: 0.2
                },
                {
                    label: '200-Day MA', type: 'line', data: ma200Data, yAxisID: 'yPrice',
                    borderColor: '#a78bfa', // violet-400
                    borderWidth: 2, pointRadius: 0, fill: false, tension: 0.2
                },
                {
                    label: 'Volume', type: 'bar', data: volumeData, yAxisID: 'yVolume',
                    backgroundColor: (context) => {
                        const index = context.dataIndex;
                        if (index < 0 || index >= priceData.length) return 'rgba(107, 114, 128, 0.4)';
                        const pricePoint = priceData[index];
                        return pricePoint.c > pricePoint.o ? 'rgba(16, 185, 129, 0.4)' : 'rgba(220, 38, 38, 0.4)'; 
                    },
                    borderColor: (context) => {
                        const index = context.dataIndex;
                        if (index < 0 || index >= priceData.length) return '#6b7280';
                        const pricePoint = priceData[index];
                        return pricePoint.c > pricePoint.o ? '#10b981' : '#dc2626'; 
                    },
                    borderWidth: 1
                }
            ];
            
            priceChartInstance = new Chart(ctx, {
                data: { datasets: datasets },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    scales: {
                        x: {
                            type: 'time', time: { unit: 'day' }, 
                            grid: { color: CHART_GRID_COLOR }, 
                            ticks: { color: CHART_TICK_COLOR } 
                        },
                        yPrice: {
                            position: 'left',
                            title: { display: true, text: 'Price ($)', color: '#10b981' }, 
                            grid: { color: CHART_GRID_COLOR },
                            ticks: { color: CHART_TICK_COLOR },
                        },
                        yVolume: {
                            position: 'right',
                            title: { display: true, text: 'Volume', color: CHART_TICK_COLOR },
                            grid: { display: false },
                            ticks: { color: CHART_TICK_COLOR, maxTicksLimit: 3, callback: (value) => value > 0 ? (value / 1000000).toFixed(1) + 'M' : '' },
                            max: Math.max(...volumeData.map(d => d.y)) * 4, min: 0
                        }
                    },
                    plugins: {
                        legend: { labels: { color: CHART_TICK_COLOR, boxWidth: 12 } },
                        tooltip: { mode: 'index', intersect: false }
                    }
                }
            });
        }
        
        // --- RSI CHART IMPLEMENTATION ---
        function drawRSIChart(dailyData) {
            if (rsiChartInstance) { rsiChartInstance.destroy(); }

            const ctxRSI = document.getElementById('rsiChart').getContext('2d');
            
            const rsiData = dailyData.map(d => ({ x: d.x, y: d.rsi_14 }));

            rsiChartInstance = new Chart(ctxRSI, {
                type: 'line',
                data: {
                    datasets: [{
                        label: 'RSI (14)', data: rsiData, yAxisID: 'yRSI',
                        borderColor: '#a3e635', // lime-400
                        borderWidth: 2, pointRadius: 0, tension: 0.4, fill: false
                    }]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    scales: {
                        x: {
                            type: 'time', time: { unit: 'day' },
                            grid: { color: CHART_GRID_COLOR },
                            ticks: { color: CHART_TICK_COLOR }
                        },
                        yRSI: {
                            position: 'left', min: 0, max: 100,
                            title: { display: false },
                            grid: { color: CHART_GRID_COLOR },
                            ticks: { color: CHART_TICK_COLOR,
                                callback: function(value, index, values) {
                                    if (value === 30 || value === 70) {
                                        return value;
                                    }
                                }
                            },
                        }
                    },
                    plugins: {
                        legend: { display: false }, tooltip: { mode: 'index', intersect: false },
                        annotation: { 
                            annotations: {
                                overboughtLine: {
                                    type: 'line', yMin: 70, yMax: 70,
                                    borderColor: 'rgba(239, 68, 68, 0.5)', borderDash: [6, 6], borderWidth: 1
                                },
                                oversoldLine: {
                                    type: 'line', yMin: 30, yMax: 30,
                                    borderColor: 'rgba(16, 185, 129, 0.5)', borderDash: [6, 6], borderWidth: 1
                                },
                                overboughtBox: { 
                                    type: 'box', yMin: 70, yMax: 100,
                                    backgroundColor: 'rgba(239, 68, 68, 0.05)',
                                    borderWidth: 0, drawTime: 'beforeDatasetsDraw'
                                },
                                oversoldBox: {
                                    type: 'box', yMin: 0, yMax: 30,
                                    backgroundColor: 'rgba(16, 185, 129, 0.05)',
                                    borderWidth: 0, drawTime: 'beforeDatasetsDraw'
                                }
                            }
                        }
                    }
                }
            });
        }


        // --- EVENT LISTENERS ---
        function setupEventListeners() {
            const searchButton = document.getElementById('searchButton');
            const symbolInput = document.getElementById('symbolInput');
            // REMOVED: navStock and navPortfolio listeners

            const handleSearch = () => {
                const symbol = symbolInput.value.trim().toUpperCase();
                if (symbol) {
                    // REMOVED: showPage call
                    fetchStockData(symbol);
                } else {
                    // REMOVED: showPage call
                    displayError("Please enter a valid stock ticker symbol.");
                }
            };

            searchButton.addEventListener('click', handleSearch);
            symbolInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') { handleSearch(); }
            });

            // REMOVED: navStock.addEventListener
            // REMOVED: navPortfolio.addEventListener
            
            // Load default stock on page load
            symbolInput.value = 'MSFT';
            fetchStockData('MSFT'); 
            
            // REMOVED: showPage('pageStockDashboard')
        }

        // --- APPLICATION START ---
        window.onload = initializeFirebase;
    </script>
</body>
</html>